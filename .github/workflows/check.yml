name: CI
on: 
  push:
  workflow_dispatch:
jobs:
  test:
    uses: ./.github/workflows/test.yml
  lint:
    uses: ./.github/workflows/lint.yml
  format:
    needs: [lint, test]
    if: ${{ failure('lint') && !failure('test') && github.branch != 'main' }}
    uses: ./.github/workflows/format.yml
    secrets: inherit
    permissions:
      contents: write
  build:
    if:  ${{ always() && !failure('lint') && !failure('test') }}
    uses: ./.github/workflows/build.yml
    needs: [format]
    with:
      environment: production
      latest-tag: ${{ github.branch == 'main' && 'latest' || format('staging_pr_{0}', github.run_number) }}
      docker-base-image: builder
      docker-namespace: oreburgh
    permissions:
      id-token: write
  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ always() && success() && github.branch == 'main' }}
    steps:
      - run: echo "DEPLOY"
    permissions:
      id-token: write