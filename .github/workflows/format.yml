on:
  workflow_call:
    inputs:
      commit-message-header:
        type: string
        default: Automatic update with format changes from linters.
      committer-name:
        type: string
        default: "[bot] rosie"
      committer-email:
        type: string
        default: "rosie@drill.run"
jobs:
   format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - id: ruff
        continue-on-error: true
        name: format ruff
        uses: ./.github/actions/mega-lint
        with:
          linter: ruff
          action: format
      - id: black
        continue-on-error: true
        name: format black
        uses: ./.github/actions/mega-lint
        with: 
          linter: black
          action: format
      - run: echo "Run Tests"
      - id: prepare-result
        uses: ./.github/actions/prepare-commit-output
        with:
          task-outputs: |-
            ruff=${{ toJSON(${{ steps.ruff.outputs.report }}) }}
            black=${{ toJSON(${{ steps.black.outputs.report }}) }}
          task-collection-rules: |-
            linters-with-fixes=lambda *a **k: k.get("remaining", 0) > 1
      - id: push-changes
        name: push changes
        if: ${{ steps.results.outputs.fixable >= 1 }}
        run: |
          git config --global user.name "${{ inputs.committer-name }}"
          git config --global user.email "${{ inputs.committer-email }}"
          git status
          git remote set-url origin https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}
          git add -u
          git commit -F- <<EOF
          ${{ inputs.commit-message-header}}

          ${{ steps.results.outputs.linters-with-fixes }}

          Signed-off-by: ${{ inputs.committer-name }} <${{ inputs.committer-email }}>
          EOF
          git push

      - id: fail-on-remaining
        if: ${{ steps.results.outputs.remaining >= 1 }}
        run: /bin/false