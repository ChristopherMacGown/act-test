on:
  workflow_call:
    inputs:
      committer-name:
        type: string
        default: "[bot] rosie"
      committer-email:
        type: string
        default: "rosie@drill.run"
jobs:
   format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - id: ruff
        continue-on-error: true
        name: format ruff
        uses: ./.github/actions/mega-lint
        with:
          linter: ruff
          action: format
      - id: black
        continue-on-error: true
        name: format black
        uses: ./.github/actions/mega-lint
        with: 
          linter: black
          action: format
      - run: echo "Run Tests"
      - id: results
        run: |
          LINT_RESULT=$(
            echo "${{ toJSON(steps.*.outputs.report) }}" |
              jq 'map(fromjson | to_entries[]) 
                    | group_by(.key) 
                    | map({(.[0].key): length}) 
                    | add'
          )

          REMAINING=$(echo $LINT_RESULT | jq '.remaining')
          FIXABLE=$(echo $LINT_RESULT | jq '.fixable')

          echo "remaining=${REMAINING}" >> $GITHUB_OUTPUT
          echo "fixable=${FIXABLE}" >> $GITHUB_OUTPUT
      - id: push-changes
        name: push changes
        if: ${{ steps.results.fixable >= 1 }}
        run: |
          echo 'git config --global user.name "${{ inputs.committer-name }}"'
          echo 'git config --global user.email "${{ inputs.committer-email }}"'
      - id: fail-on-remaining
        if: ${{ steps.results.remaining >= 1 }}
        run: /bin/false